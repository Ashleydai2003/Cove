# Database Schema Migrations Workflow
# This workflow runs database migrations when the Prisma schema changes
# It uses your existing EC2 instance and replicates your manual migration process

name: Database Migrations

# Only trigger when the Prisma schema file changes
on:
  push:
    branches: [main, develop, ci/test-deploy]
    paths:
      - 'Backend/prisma/schema.prisma'  # Only run when schema changes
  workflow_dispatch:  # Allow manual triggering for testing

# Environment variables
env:
  AWS_REGION: 'us-west-1'  # Your AWS region

jobs:
  # Migration job - starts EC2, runs migrations, stops EC2
  migrate:
    name: Run Database Migrations
    runs-on: ubuntu-latest
    
    # Use GitHub environments for deployment protection
    environment: 
      name: ${{ github.ref == 'refs/heads/main' && 'production' || 'staging' }}
    
    # Required permissions for AWS access
    permissions:
      id-token: write   # For OIDC authentication
      contents: read    # To read repository contents

    steps:
      # Get the code
      - name: Checkout code
        uses: actions/checkout@v4

      # Authenticate with AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Migrations

      # Start your dedicated migration EC2 instance
      # This is cost-efficient: only run when schema changes
      - name: Start EC2 instance for migrations
        run: |
          echo "üöÄ Starting EC2 instance for database migrations..."
          echo "Schema changes detected in: Backend/prisma/schema.prisma"
          
          # Start the instance using the instance ID from your secrets
          aws ec2 start-instances --instance-ids ${{ secrets.EC2_INSTANCE_ID }}
          
          # Wait for the instance to be fully running before proceeding
          # This ensures SSM is ready to accept commands
          aws ec2 wait instance-running --instance-ids ${{ secrets.EC2_INSTANCE_ID }}
          echo "‚úÖ EC2 instance is running and ready for migrations"

      # Run database migrations using AWS Systems Manager (SSM)
      # This matches your exact manual process
      - name: Run database migrations
        run: |
          echo "üìã Running database migrations via SSM..."
          
          # Generate migration name using GitHub username and timestamp for uniqueness
          MIGRATION_NAME="${{ github.actor }}-$(date +%Y%m%d-%H%M%S)"
          echo "Migration name: $MIGRATION_NAME"
          
          # Send commands to EC2 instance via SSM (matches your manual process)
          COMMAND_ID=$(aws ssm send-command \
            --document-name "AWS-RunShellScript" \
            --targets "Key=instanceids,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --comment "Database migration from GitHub Actions - Schema: $MIGRATION_NAME" \
            --parameters "commands=[
              \"echo 'üîÑ Starting migration process...'\",
              \"echo 'üñ•Ô∏è  System info:'\",
              \"whoami && pwd && date\",
              \"echo 'üìÅ Checking directories (showing only directory names):'\",
              \"ls -1 ~/ | head -10 || echo 'Directory listing failed'\",
              \"source /etc/profile\",
              \"echo 'üóÇÔ∏è  Navigating to Cove directory...'\",
              \"cd ~/Cove || (echo '‚ùå Cove directory not found' && ls -1 ~/ && exit 1)\",
              \"echo '‚úÖ Successfully in Cove directory: \$(pwd)'\",
              \"echo 'üåø Current git status:'\",
              \"git status --porcelain || echo 'Git status failed'\",
              \"git branch -a | head -5 || echo 'Git branch failed'\",
              \"echo 'üì• Pulling latest code from ${{ github.ref_name }}...'\",
              \"git fetch origin || (echo '‚ùå Git fetch failed' && exit 1)\",
              \"git checkout ${{ github.ref_name }} || (echo '‚ùå Git checkout failed' && exit 1)\",
              \"git pull origin ${{ github.ref_name }} || (echo '‚ùå Git pull failed' && exit 1)\",
              \"echo 'üìÇ Navigating to Backend directory...'\",
              \"cd Backend || (echo '‚ùå Backend directory not found' && ls -1 && exit 1)\",
              \"echo '‚úÖ In Backend directory: \$(pwd)'\",
              \"echo 'üì¶ Checking package.json and dependencies...'\",
              \"ls -1 package*.json || echo 'No package files found'\",
              \"echo 'üì¶ Installing/updating dependencies...'\",
              \"npm ci || (echo '‚ùå npm ci failed, trying npm install' && npm install)\",
              \"echo 'üîß Generating Prisma client...'\",
              \"npm run prisma:generate || (echo '‚ùå Prisma generate failed' && exit 1)\",
              \"echo '‚ÑπÔ∏è  Node version: \$(node -v)'\",
              \"echo '‚ÑπÔ∏è  NPM version: \$(npm -v)'\",
              \"echo '‚ÑπÔ∏è  Checking Prisma version...'\",
              \"npx prisma -v\",
              \"echo 'üîê Getting database credentials from Secrets Manager...'\",
              \"DB_SECRET=\$(aws secretsmanager get-secret-value --secret-id ${{ secrets.RDS_SECRET_ARN }} --query SecretString --output text) || (echo '‚ùå Failed to get DB secret' && exit 1)\",
              \"echo 'üîç Parsing database credentials...'\",
              \"DB_PASSWORD=\$(echo \$DB_SECRET | jq -r .password) || (echo '‚ùå Failed to parse password' && exit 1)\",
              \"DB_HOST=\$(echo \$DB_SECRET | jq -r .host) || (echo '‚ùå Failed to parse host' && exit 1)\",
              \"DB_USER=\$(echo \$DB_SECRET | jq -r .username) || (echo '‚ùå Failed to parse username' && exit 1)\",
              \"DB_NAME=\$(echo \$DB_SECRET | jq -r .dbname) || (echo '‚ùå Failed to parse dbname' && exit 1)\",
              \"echo 'üîó Setting up database connection (credentials masked)...'\",
              \"export DATABASE_URL=\\\"postgresql://\$DB_USER:\$DB_PASSWORD@\$DB_HOST:5432/\$DB_NAME\\\"\",
              \"echo '‚ÑπÔ∏è  DATABASE_URL is (masked):'\",
              \"echo \\\"\$DATABASE_URL\\\" | sed -E 's/(\/\/[^:]+):[^@]+(@[^\/]+)/\\\\1:****\\\\2/'\",
              \"echo 'üß™ Show existing migration files:'\",
              \"ls -R prisma/migrations || echo '‚ùå No migrations found'\",
              \"echo 'üîç Testing database connection (output may contain sensitive info - suppressing)...'\",
              \"npx prisma db status >/dev/null 2>&1 && echo '‚úÖ Database connection successful' || echo '‚ö†Ô∏è  Database connection test failed (continuing anyway)'\",
              \"echo 'üß† Bonus sanity check - Current DB:'\",
              \"psql \\\"\$DATABASE_URL\\\" -c 'SELECT current_database();' || echo '‚ö†Ô∏è  Could not connect to verify database name'\",
              \"echo 'üìù Creating migration: $MIGRATION_NAME'\",
              \"echo '$MIGRATION_NAME' | npm run prisma:dev || (echo '‚ùå Migration creation failed' && exit 1)\",
              \"echo 'üìÑ Migration file contents (after prisma:dev):'\",
              \"ls -l prisma/migrations\",
              \"cat prisma/migrations/*/migration.sql || echo '‚ùå No SQL file found'\",
              \"echo 'üìä Prisma db status (before migrate):'\",
              \"npx prisma db status || echo '‚ùå Could not get DB status'\",
              \"echo 'üöÄ Running migration...'\",
              \"npm run prisma:migrate || (echo '‚ùå Migration execution failed' && exit 1)\",
              \"echo '‚úÖ Migration completed successfully!'\",
              \"echo 'üîç Final status check (suppressing sensitive output)...'\",
              \"npx prisma db status >/dev/null 2>&1 && echo '‚úÖ Database status check passed' || echo '‚ö†Ô∏è  Final status check failed'\",
              \"echo 'üéâ All done! Migration process completed.'\",
              \"echo 'üìä Final summary:'\",
              \"echo '  - Migration name: $MIGRATION_NAME'\",
              \"echo '  - Branch: ${{ github.ref_name }}'\",
              \"echo '  - Directory: \$(pwd)'\",
              \"echo '  - Timestamp: \$(date)'\",
              \"echo 'üèÅ Migration workflow finished successfully!'\"
            ]" \
            --region ${{ env.AWS_REGION }} \
            --output text --query 'Command.CommandId')
          
          echo "Command ID: $COMMAND_ID"
          
          # Wait for the migration command to complete (with timeout)
          echo "‚è≥ Waiting for migration to complete (timeout: 10 minutes)..."
          timeout 600 aws ssm wait command-executed \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ env.AWS_REGION }} || echo "‚ö†Ô∏è Wait command timed out or failed, checking status manually..."
          
          # Check current command status
          echo "üîç Checking command status..."
          STATUS=$(aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' \
            --output text 2>/dev/null || echo "Unknown")
          
          echo "üìä Command Status: $STATUS"
          
          # Display the migration output for debugging
          echo "üìÑ Migration output:"
          aws ssm get-command-invocation \
            --command-id "$COMMAND_ID" \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ env.AWS_REGION }} \
            --query 'StandardOutputContent' \
            --output text 2>/dev/null || echo "No output available yet"
          
          # If migration failed, show error details and fail the workflow
          if [ "$STATUS" != "Success" ]; then
            echo "‚ùå Migration failed with status: $STATUS"
            echo ""
            echo "=== STANDARD OUTPUT ==="
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }} \
              --query 'StandardOutputContent' \
              --output text
            echo ""
            echo "=== ERROR OUTPUT ==="
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }} \
              --query 'StandardErrorContent' \
              --output text
            echo ""
            echo "=== COMMAND DETAILS ==="
            aws ssm get-command-invocation \
              --command-id "$COMMAND_ID" \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --region ${{ env.AWS_REGION }} \
              --output json
            exit 1  # Fail the workflow
          fi
          
          echo "üéâ Database migration completed successfully!"

      # Always stop the EC2 instance to save costs
      # This runs even if the migration failed
      - name: Stop EC2 instance
        if: always()
        run: |
          echo "üõë Stopping EC2 instance to save costs..."
          aws ec2 stop-instances --instance-ids ${{ secrets.EC2_INSTANCE_ID }}
          echo "üí∞ EC2 instance stopped - costs saved!" 
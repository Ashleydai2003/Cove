# CI/CD Setup Validation Workflow
# This workflow validates that your CI/CD infrastructure is properly configured
# Run this before attempting actual deployments to catch configuration issues early

name: Validate CI/CD Setup

on:
  workflow_dispatch:        # Allow manual triggering from GitHub Actions UI
  pull_request:            # Run when CI/CD configuration files are changed
    paths: ['.github/workflows/**', 'CI-CD-SETUP.md']  # Only trigger on workflow or doc changes

env:
  AWS_REGION: us-west-1    # Your AWS region (matches production infrastructure)

jobs:
  # =============================================================================
  # AWS VALIDATION JOB - Tests AWS infrastructure connectivity and permissions
  # Validates EC2, SSM, Lambda, and RDS secret access
  # =============================================================================
  validate-aws-setup:
    name: Validate AWS Configuration
    runs-on: ubuntu-latest
    
    # Required permissions for OIDC authentication
    permissions:
      id-token: write   # Needed to request OIDC token from GitHub
      contents: read    # Needed to read repository contents

    steps:
      # Get the repository code (needed for checkout action)
      - name: Checkout code
        uses: actions/checkout@v4

      # Test OIDC authentication with your AWS role
      # This verifies that the GitHub Actions role is properly configured
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}        # Your GitHubActionsRole ARN
          aws-region: ${{ env.AWS_REGION }}                  # us-west-1
          role-session-name: GitHubActions-Validate         # Session name for CloudTrail logs

      # Test that the EC2 instance exists and is accessible
      # This validates the instance ID and basic EC2 permissions
      - name: Validate EC2 instance
        run: |
          echo "üîç Checking EC2 instance status..."
          # Query the instance to verify it exists and get basic info
          aws ec2 describe-instances \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Reservations[0].Instances[0].{State:State.Name,Type:InstanceType,VPC:VpcId}' \
            --output table
          
          echo "‚úÖ EC2 instance validated"

      # Test SSM (Systems Manager) connectivity to the EC2 instance
      # This is crucial for running migration commands remotely
      - name: Validate SSM connectivity
        run: |
          echo "üîç Checking SSM connectivity..."
          # Check if the instance is registered with SSM and can receive commands
          aws ssm describe-instance-information \
            --filters "Key=InstanceIds,Values=${{ secrets.EC2_INSTANCE_ID }}" \
            --query 'InstanceInformationList[0].{PingStatus:PingStatus,LastPingDateTime:LastPingDateTime,PlatformType:PlatformType}' \
            --output table
          
          echo "‚úÖ SSM connectivity validated"

      # Test that the Lambda function exists and is accessible
      # This validates the function name and basic Lambda permissions
      - name: Validate Lambda function
        run: |
          echo "üîç Checking Lambda function..."
          # Get basic information about the Lambda function
          aws lambda get-function \
            --function-name hello-lambda \
            --query '{FunctionName:Configuration.FunctionName,Runtime:Configuration.Runtime,LastModified:Configuration.LastModified}' \
            --output table
          
          echo "‚úÖ Lambda function validated"

      # Test access to the RDS database credentials in Secrets Manager
      # This is needed for the migration scripts to connect to the database
      - name: Validate RDS secret
        run: |
          echo "üîç Checking RDS secret access..."
          # Verify we can access the secret metadata (not the actual password)
          aws secretsmanager describe-secret \
            --secret-id ${{ secrets.RDS_SECRET_ARN }} \
            --query '{Name:Name,LastChangedDate:LastChangedDate,Description:Description}' \
            --output table
          
          echo "‚úÖ RDS secret access validated"

  validate-backend-build:
    name: Validate Backend Build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: Backend/package-lock.json

      - name: Install dependencies
        working-directory: Backend
        run: npm ci

      - name: Validate Prisma schema
        working-directory: Backend
        run: |
          echo "üîç Validating Prisma schema..."
          npm run prisma:generate
          echo "‚úÖ Prisma schema validated"

      - name: Test build process
        working-directory: Backend
        run: |
          echo "üîç Testing build process..."
          npm run build
          
          # Check if build artifacts exist
          if [ -f "dist/index.zip" ]; then
            echo "‚úÖ Build artifacts created successfully"
            ls -la dist/
          else
            echo "‚ùå Build artifacts not found"
            exit 1
          fi

  validate-ios-project:
    name: Validate iOS Project
    runs-on: macos-14
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Validate Xcode project
        working-directory: CoveApp
        run: |
          echo "üîç Validating Xcode project..."
          
          # Check if project file exists
          if [ ! -f "Cove.xcodeproj/project.pbxproj" ]; then
            echo "‚ùå Xcode project not found"
            exit 1
          fi
          
          # Validate project can be opened
          xcodebuild -list -project Cove.xcodeproj
          
          echo "‚úÖ Xcode project validated"

      - name: Resolve dependencies
        working-directory: CoveApp
        run: |
          echo "üîç Resolving Swift Package dependencies..."
          xcodebuild -resolvePackageDependencies -project Cove.xcodeproj -scheme "Cove iOS"
          echo "‚úÖ Dependencies resolved"

      - name: Test build (no signing)
        working-directory: CoveApp
        run: |
          echo "üîç Testing build without code signing..."
          xcodebuild build \
            -project Cove.xcodeproj \
            -scheme "Cove iOS" \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -configuration Debug \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO
          
          echo "‚úÖ Build test completed"

  validate-secrets:
    name: Validate Required Secrets
    runs-on: ubuntu-latest
    
    steps:
      - name: Check AWS secrets
        run: |
          echo "üîç Checking AWS secrets..."
          
          # Check if required AWS secrets exist
          if [ -z "${{ secrets.AWS_ROLE_ARN }}" ]; then
            echo "‚ùå AWS_ROLE_ARN secret not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.EC2_INSTANCE_ID }}" ]; then
            echo "‚ùå EC2_INSTANCE_ID secret not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.RDS_SECRET_ARN }}" ]; then
            echo "‚ùå RDS_SECRET_ARN secret not set"
            exit 1
          fi
          
          echo "‚úÖ AWS secrets validated"

      - name: Check iOS secrets (optional)
        run: |
          echo "üîç Checking iOS secrets..."
          
          # Check if iOS secrets exist (optional for backend-only validation)
          if [ -n "${{ secrets.IOS_TEAM_ID }}" ]; then
            echo "‚úÖ iOS secrets appear to be configured"
          else
            echo "‚ö†Ô∏è  iOS secrets not configured (required for iOS deployment)"
          fi

  summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [validate-aws-setup, validate-backend-build, validate-ios-project, validate-secrets]
    if: always()
    
    steps:
      - name: Validation Results
        run: |
          echo "## üéØ CI/CD Setup Validation Results"
          echo ""
          
          if [ "${{ needs.validate-aws-setup.result }}" == "success" ]; then
            echo "‚úÖ AWS Configuration: PASSED"
          else
            echo "‚ùå AWS Configuration: FAILED"
          fi
          
          if [ "${{ needs.validate-backend-build.result }}" == "success" ]; then
            echo "‚úÖ Backend Build: PASSED"
          else
            echo "‚ùå Backend Build: FAILED"
          fi
          
          if [ "${{ needs.validate-ios-project.result }}" == "success" ]; then
            echo "‚úÖ iOS Project: PASSED"
          else
            echo "‚ùå iOS Project: FAILED"
          fi
          
          if [ "${{ needs.validate-secrets.result }}" == "success" ]; then
            echo "‚úÖ Required Secrets: PASSED"
          else
            echo "‚ùå Required Secrets: FAILED"
          fi
          
          echo ""
          echo "## üìã Next Steps"
          
          if [ "${{ needs.validate-aws-setup.result }}" == "success" ] && [ "${{ needs.validate-backend-build.result }}" == "success" ]; then
            echo "üöÄ Backend deployment is ready!"
          else
            echo "‚ö†Ô∏è  Backend deployment needs attention"
          fi
          
          if [ "${{ needs.validate-ios-project.result }}" == "success" ]; then
            echo "üì± iOS project validation passed - add iOS secrets for deployment"
          else
            echo "‚ö†Ô∏è  iOS project needs attention"
          fi
          
          echo ""
          echo "See CI-CD-SETUP.md for detailed setup instructions." 
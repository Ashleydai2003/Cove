# iOS CI/CD Pipeline
# This workflow handles testing, building, and deploying the iOS app
# It supports both TestFlight (staging) and App Store (production) deployment

name: iOS Deploy

on:
  push:
    branches: [main, develop]  # Deploy on pushes to main (App Store) and develop (TestFlight)
    paths: ['CoveApp/**', 'Assets/**', 'SupportingFiles/**', 'Utilities/**']  # Only iOS-related files
  pull_request:
    branches: [main]           # Run tests on PRs to main branch
    paths: ['CoveApp/**', 'Assets/**', 'SupportingFiles/**', 'Utilities/**']  # Only iOS-related files

env:
  XCODE_VERSION: '15.2'                    # Xcode version available on GitHub Actions runners
  IOS_SCHEME: 'Cove iOS'                   # The scheme name from your Xcode project
  IOS_PROJECT: 'CoveApp/Cove.xcodeproj'   # Path to your Xcode project file
  ARCHIVE_PATH: 'build/Cove.xcarchive'    # Where to save the archive
  IPA_PATH: 'build/Cove.ipa'              # Where to save the final IPA file

jobs:
  # =============================================================================
  # TEST JOB - Runs unit tests on iOS simulator
  # This runs on all PRs and pushes to catch bugs early
  # =============================================================================
  test:
    name: Test iOS App
    runs-on: macos-14  # Use macOS runner with Xcode pre-installed
    
    steps:
      # Get the latest code from the repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Select the specific Xcode version to ensure consistency
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      # Cache Swift Package Manager dependencies to speed up builds
      # This saves significant time on subsequent runs
      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm              # SPM cache directory
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages  # Xcode SPM cache
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}  # Cache key based on lockfile
          restore-keys: |
            ${{ runner.os }}-spm-  # Fallback cache key

      # Download and resolve all Swift Package Manager dependencies
      # This ensures all third-party libraries are available
      - name: Install dependencies
        working-directory: CoveApp
        run: |
          # Resolve Swift Package Manager dependencies
          # This downloads packages like Firebase, Kingfisher, etc.
          xcodebuild -resolvePackageDependencies -project Cove.xcodeproj -scheme "${{ env.IOS_SCHEME }}"

      # Build the app for testing without code signing (since we're using simulator)
      # This compiles the code and catches build errors
      - name: Build for testing
        working-directory: CoveApp
        run: |
          xcodebuild build-for-testing \
            -project Cove.xcodeproj \
            -scheme "${{ env.IOS_SCHEME }}" \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \  # Use iPhone 15 simulator
            -configuration Debug \        # Debug configuration for faster builds
            CODE_SIGN_IDENTITY="" \       # No code signing needed for simulator
            CODE_SIGNING_REQUIRED=NO      # Disable code signing requirements

      # Run the actual unit tests using the pre-built app
      # This executes your XCTest test cases
      - name: Run unit tests
        working-directory: CoveApp
        run: |
          xcodebuild test-without-building \
            -project Cove.xcodeproj \
            -scheme "${{ env.IOS_SCHEME }}" \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \  # Same simulator as build
            -configuration Debug \        # Same configuration as build
            CODE_SIGN_IDENTITY="" \       # No code signing needed
            CODE_SIGNING_REQUIRED=NO     # Disable code signing

  # =============================================================================
  # BUILD STAGING JOB - Creates TestFlight build for internal testing
  # Only runs on pushes to develop branch after tests pass
  # =============================================================================
  build-staging:
    name: Build Staging
    runs-on: macos-14                                            # macOS runner for Xcode
    needs: test                                                  # Wait for tests to pass
    if: github.event_name == 'push' && github.ref == 'refs/heads/develop'  # Only on develop branch pushes
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      # Set up code signing certificates and provisioning profiles
      # This is required for building apps that can be uploaded to TestFlight/App Store
      - name: Install Apple Certificate and Provisioning Profile
        env:
          P12_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE_P12 }}           # Base64 encoded .p12 certificate
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}         # Password for the certificate
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE_STAGING }}  # Base64 encoded provisioning profile
        run: |
          # Create a temporary keychain to store the certificate securely
          # This avoids polluting the default keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)  # Generate random password
          
          # Create and configure the temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"    # Lock after 6 hours
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import the distribution certificate into the keychain
          echo "$P12_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"  # Set as default keychain
          
          # Install the provisioning profile for code signing
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/staging.mobileprovision

      - name: Build and Archive (Staging)
        working-directory: CoveApp
        run: |
          xcodebuild archive \
            -project Cove.xcodeproj \
            -scheme "${{ env.IOS_SCHEME }}" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "../${{ env.ARCHIVE_PATH }}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME_STAGING }}"

      - name: Export IPA (Staging)
        run: |
          # Create export options plist
          cat > export-options-staging.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath "${{ env.ARCHIVE_PATH }}" \
            -exportPath build/ \
            -exportOptionsPlist export-options-staging.plist

      - name: Upload to TestFlight (Staging)
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # Create API key file
          mkdir -p private_keys
          echo "$APP_STORE_CONNECT_API_KEY" | base64 --decode > private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          
          # Upload to TestFlight
          xcrun altool --upload-app \
            --type ios \
            --file "${{ env.IPA_PATH }}" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

  build-production:
    name: Build Production
    runs-on: macos-14
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/org.swift.swiftpm
            ~/Library/Developer/Xcode/DerivedData/**/SourcePackages
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Install Apple Certificate and Provisioning Profile
        env:
          P12_CERTIFICATE: ${{ secrets.IOS_CERTIFICATE_P12 }}
          P12_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE: ${{ secrets.IOS_PROVISIONING_PROFILE_PRODUCTION }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/build.keychain
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import certificate
          echo "$P12_CERTIFICATE" | base64 --decode > $RUNNER_TEMP/certificate.p12
          security import $RUNNER_TEMP/certificate.p12 -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          # Install provisioning profile
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/production.mobileprovision

      - name: Increment build number
        working-directory: CoveApp
        run: |
          # Get current build number and increment it
          CURRENT_BUILD=$(xcodebuild -project Cove.xcodeproj -showBuildSettings -configuration Release | grep CURRENT_PROJECT_VERSION | awk '{print $3}' | head -1)
          NEW_BUILD=$((CURRENT_BUILD + 1))
          
          # Update build number in project
          xcrun agvtool new-version -all $NEW_BUILD
          
          echo "Updated build number from $CURRENT_BUILD to $NEW_BUILD"

      - name: Build and Archive (Production)
        working-directory: CoveApp
        run: |
          xcodebuild archive \
            -project Cove.xcodeproj \
            -scheme "${{ env.IOS_SCHEME }}" \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -archivePath "../${{ env.ARCHIVE_PATH }}" \
            DEVELOPMENT_TEAM="${{ secrets.IOS_TEAM_ID }}" \
            CODE_SIGN_STYLE=Manual \
            PROVISIONING_PROFILE_SPECIFIER="${{ secrets.IOS_PROVISIONING_PROFILE_NAME_PRODUCTION }}"

      - name: Export IPA (Production)
        run: |
          # Create export options plist
          cat > export-options-production.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>app-store</string>
              <key>teamID</key>
              <string>${{ secrets.IOS_TEAM_ID }}</string>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <true/>
              <key>compileBitcode</key>
              <false/>
          </dict>
          </plist>
          EOF
          
          xcodebuild -exportArchive \
            -archivePath "${{ env.ARCHIVE_PATH }}" \
            -exportPath build/ \
            -exportOptionsPlist export-options-production.plist

      - name: Upload to App Store
        env:
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_KEY_ID: ${{ secrets.APP_STORE_CONNECT_KEY_ID }}
        run: |
          # Create API key file
          mkdir -p private_keys
          echo "$APP_STORE_CONNECT_API_KEY" | base64 --decode > private_keys/AuthKey_${{ secrets.APP_STORE_CONNECT_KEY_ID }}.p8
          
          # Upload to App Store
          xcrun altool --upload-app \
            --type ios \
            --file "${{ env.IPA_PATH }}" \
            --apiKey "${{ secrets.APP_STORE_CONNECT_KEY_ID }}" \
            --apiIssuer "$APP_STORE_CONNECT_ISSUER_ID"

      - name: Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ios-v${{ github.run_number }}
          release_name: iOS Release v${{ github.run_number }}
          body: |
            üöÄ iOS Production Release
            
            **Changes in this release:**
            ${{ github.event.head_commit.message }}
            
            **Commit:** ${{ github.sha }}
            **Branch:** ${{ github.ref_name }}
            
            This build has been uploaded to the App Store for review.
          draft: false
          prerelease: false

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [test, build-staging, build-production]
    if: always() && github.event_name == 'push'
    
    steps:
      - name: Staging Deployment Success
        if: needs.build-staging.result == 'success'
        run: |
          echo "üöÄ iOS staging build uploaded to TestFlight!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
      - name: Production Deployment Success
        if: needs.build-production.result == 'success'
        run: |
          echo "üöÄ iOS production build uploaded to App Store!"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          
      - name: Deployment Failed
        if: (needs.build-staging.result == 'failure') || (needs.build-production.result == 'failure')
        run: |
          echo "‚ùå iOS deployment failed!"
          echo "Check the logs above for details."
          exit 1 
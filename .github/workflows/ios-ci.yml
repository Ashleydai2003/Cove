name: iOS CI/CD Pipeline

on:
  push:
    branches: [main, develop]
    paths:
      - 'CoveApp/**'
  pull_request:            # Run on all PRs to avoid blocking merges

jobs:
  validate-ios:
    name: Validate iOS Code
    runs-on: macos-14
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Check if iOS files have changed
      - name: Check for iOS changes
        id: ios-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For pull requests, compare with base branch
            git fetch origin ${{ github.base_ref }}
            if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E 'CoveApp/' > /dev/null; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ” iOS files have changed - running validation"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No iOS changes detected - skipping validation"
            fi
          else
            # For pushes, check if CoveApp files exist
            if find CoveApp -name "*.swift" -o -name "*.xcodeproj" | head -1 | grep -q .; then
              echo "changes=true" >> $GITHUB_OUTPUT
              echo "ðŸ” iOS files detected - running validation"
            else
              echo "changes=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  No iOS files detected - skipping validation"
            fi
          fi

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show Xcode version
        run: |
          which xcodebuild
          xcodebuild -version

      - name: List available simulators
        run: xcrun simctl list devices

      # Check for disallowed print() statements
      - name: Check for disallowed print() statements
        if: steps.ios-changes.outputs.changes == 'true'
        run: ./scripts/check_no_prints.sh

      # - name: Install SwiftLint
      #   if: steps.ios-changes.outputs.changes == 'true'
      #   run: brew install swiftlint

      # - name: Run SwiftLint
      #   if: steps.ios-changes.outputs.changes == 'true'
      #   run: swiftlint --strict

      - name: Resolve Swift Package dependencies
        if: steps.ios-changes.outputs.changes == 'true'
        run: xcodebuild -resolvePackageDependencies -project CoveApp/Cove.xcodeproj

      - name: Build (Debug, no signing)
        if: steps.ios-changes.outputs.changes == 'true'
        run: xcodebuild -scheme Cove -project CoveApp/Cove.xcodeproj -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.5' build CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      # Skip validation message
      - name: Skip validation
        if: steps.ios-changes.outputs.changes == 'false'
        run: |
          echo "âœ… Skipping iOS validation - no iOS changes detected"

  test-ios:
    name: Run iOS Tests
    runs-on: macos-14
    needs: validate-ios
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show Xcode version
        run: xcodebuild -version

      # Check if iOS files have changed
      - name: Check for iOS changes
        id: ios-changes
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # For pull requests, compare with base branch
            git fetch origin ${{ github.base_ref }}
            if git diff --name-only origin/${{ github.base_ref }}..HEAD | grep -E 'CoveApp/' > /dev/null; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ” iOS files have changed - running tests"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â­ï¸  No iOS changes detected - skipping tests"
            fi
          else
            # For pushes, check if CoveApp files exist
            if find CoveApp -name "*.swift" -o -name "*.xcodeproj" | head -1 | grep -q .; then
              echo "changes=true" >> $GITHUB_OUTPUT
              echo "ðŸ” iOS files detected - running tests"
            else
              echo "changes=false" >> $GITHUB_OUTPUT
              echo "â­ï¸  No iOS files detected - skipping tests"
            fi
          fi

      - name: Run Unit Tests
        if: steps.ios-changes.outputs.changes == 'true'
        run: xcodebuild test -scheme Cove -project CoveApp/Cove.xcodeproj -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.5' CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      - name: Run UI Tests
        if: steps.ios-changes.outputs.changes == 'true'
        run: xcodebuild test -scheme Cove -project CoveApp/Cove.xcodeproj -sdk iphonesimulator -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.5' -only-testing:CoveUITests CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      # Skip tests message
      - name: Skip tests
        if: steps.ios-changes.outputs.changes == 'false'
        run: |
          echo "âœ… Skipping iOS tests - no iOS changes detected"

  build-ios:
    name: Build iOS App
    runs-on: macos-14
    needs: [validate-ios, test-ios]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: 'latest-stable'

      - name: Show Xcode version
        run: xcodebuild -version

      # Comment out certificate installation for now since we don't have the secrets configured
      # - name: Install certificates
      #   uses: apple-actions/import-codesigning-certs@v1
      #   with:
      #     p12-file-base64: ${{ secrets.P12_BASE64 }}
      #     p12-password: ${{ secrets.P12_PASSWORD }}

      # TODO: APP_STORE_CONNECT_API_ISSUER_ID - App Store Connect API issuer ID - From App Store Connect â†’ Users and Access â†’ Keys
      # TODO: APP_STORE_CONNECT_API_KEY_ID - App Store Connect API key ID - From App Store Connect â†’ Users and Access â†’ Keys  
      # TODO: APP_STORE_CONNECT_API_KEY - App Store Connect API private key (base64) - Download from App Store Connect, then base64 encode
      # - name: Download provisioning profiles
      #   uses: apple-actions/download-provisioning-profiles@v1
      #   with:
      #     bundle-id: 'co.coveapp.CoveApp'
      #     profile-type: 'IOS_APP_STORE'
      #     issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
      #     api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
      #     api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

      - name: Build and Archive
        run: |
          xcodebuild -scheme Cove -project CoveApp/Cove.xcodeproj \
            -configuration Release \
            -archivePath Cove.xcarchive \
            -destination 'generic/platform=iOS' \
            archive CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO

      - name: Create export options plist
        run: |
          cat > exportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>development</string>
              <key>teamID</key>
              <string>YOUR_TEAM_ID</string>
              <key>signingStyle</key>
              <string>manual</string>
              <key>stripSwiftSymbols</key>
              <true/>
              <key>uploadBitcode</key>
              <false/>
              <key>uploadSymbols</key>
              <false/>
          </dict>
          </plist>
          EOF

      - name: Export IPA
        run: |
          xcodebuild -exportArchive \
            -archivePath Cove.xcarchive \
            -exportPath ./build \
            -exportOptionsPlist exportOptions.plist

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: ./build/*.ipa

  # TODO: TestFlight Distribution
  # deploy-testflight:
  #   name: Deploy to TestFlight
  #   runs-on: macos-14
  #   needs: build-ios
  #   if: github.ref == 'refs/heads/develop'
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: ios-build
  #
  #     - name: Upload to TestFlight
  #       uses: apple-actions/upload-testflight@v1
  #       with:
  #         app-path: '*.ipa'
  #         issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
  #         api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  #         api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

  # TODO: App Store Distribution
  # deploy-appstore:
  #   name: Deploy to App Store
  #   runs-on: macos-14
  #   needs: build-ios
  #   if: github.ref == 'refs/heads/main'
  #   steps:
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: ios-build
  #
  #     - name: Upload to App Store
  #       uses: apple-actions/upload-appstore@v1
  #       with:
  #         app-path: '*.ipa'
  #         issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
  #         api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
  #         api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}

# Required GitHub Secrets for iOS CI/CD:
# - P12_BASE64: Base64 encoded p12 certificate
# - P12_PASSWORD: Password for p12 certificate
# - APP_STORE_CONNECT_API_ISSUER_ID: App Store Connect API issuer ID
# - APP_STORE_CONNECT_API_KEY_ID: App Store Connect API key ID
# - APP_STORE_CONNECT_API_KEY: App Store Connect API private key (base64 encoded)
#
# TODO: TestFlight Setup
# 1. Configure App Store Connect API access
# 2. Set up TestFlight distribution certificates
# 3. Configure provisioning profiles for TestFlight
# 4. Uncomment and configure TestFlight deployment job
#
# TODO: App Store Setup
# 1. Configure App Store distribution certificates
# 2. Set up App Store provisioning profiles
# 3. Configure App Store Connect metadata
# 4. Uncomment and configure App Store deployment job 